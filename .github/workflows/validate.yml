name: Validation Workflow

# Definition when the workflow should run - Trigger on pull request to specified branches
on:
  pull_request:
	# The events are that a PR is opened, or when a commit is pushed
      	# to a branch that has an existing pull request
      
      types: [opened,synchronize]
      branches: [ main ]

	# We only care about changes to the force-app directory, which is the
      	# root directory of the sfdx project. This prevents the job from running
      	# when changing non-salesforce files (like this yml file).

      paths:
        - 'force-app/**'

  workflow_dispatch:

jobs:
  Validate and Deployment of Job:

    runs-on: ubuntu-latest
    
if: ${{ github.actor != 'dependabot[bot]' }}
steps:
            - uses: actions/setup-node@v3
              with:
                node-version: '14'
                steps:
                - name: 'Checkout Source code'
                uses: actions/checkout@v3
                with:
                fetch-depth: 0
                
                - name: 'Check commit messages for the presence of jira issue key number'
                uses: gsactions/commit-message-checker@v2
        with:
         pattern: '[A-Z]{4,}-\d+'
         error: 'You need to mention the corresponding jira issue key number in commit message'  
          
#Need to check for the test classes part

  Validate:
    needs: Pre-Check
    if: |
          (github.event_name == 'pull_request') && 
          (((github.event.action == 'opened' || github.event.action == 'synchronize') && 
          ((contains(github.head_ref, 'feature') && github.base_ref == 'base branch name') ||
          contains(github.head_ref, 'hotfix') && github.base_ref == 'base branch name')))

    runs-on: ubuntu-latest

    steps:
          
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Install Salesforce CLI
        uses: sfdx-actions/setup-sfdx@v1

#	 - name: 'Install Salesforce CLI'
 #             run: |
  #                wget https://developer.salesforce.com/media/salesforce-cli/sfdx/channels/stable/sfdx-linux-x64.tar.xz
   #               mkdir ~/sfdx
    #              tar xJf sfdx-linux-x64.tar.xz -C ~/sfdx --strip-components 1
     #             echo "$HOME/sfdx/bin" >> $GITHUB_PATH
      #            ~/sfdx/bin/sfdx version
      
      - name: Salesforce CLI Health check
        run: |
            echo "Salesforce CLI Installed Succesfully!"
            sf -v


	    # Install the SFDX-Git-Delta plugin - https://github.com/scolladon/sfdx-git-delta
            # This is an plugin that allows us to extract a package.xml with the metadata that has changed between commits.

            - name: 'Installing sfdx git delta'
              run: | 
                  echo y | sfdx plugins:install sfdx-git-delta
                  sfdx plugins 

            # Install java as it is required

            - name: 'Installing java'
              run: |
                sudo apt-get update
                sudo apt install default-jdk

            # Install SFDX scanner
            - name: 'Installing SFDX scanner'
              run: sfdx plugins:install @salesforce/sfdx-scanner

	    #Prior to setting up this workflow, you have to create a Github Secret that contains the sfdx url of the integration/qa org.

            # The steps to generate the url are here 
            # https://developer.salesforce.com/docs/atlas.en-us.sfdx_cli_reference.meta/sfdx_cli_reference/cli_reference_auth_sfdxurl.htm

            # This URL can then be used with the sfdx auth:sfdxurl:store to authenticate
            # the sfdx project in the repositry, against the org from which the URL
            # was generated from. This works just like that, there's no need to create
            # connected apps or any else. 

            # The URL is stored in the Github Secret named SFDX_INTEGRATION_URL
            # so here we store the URL into a text file	

	 - name: 'Populate auth file with SFDX_URL secret of integration org'
              shell: bash
              run: |
                  echo ${{ secrets.SFDX_INTEGRATION_URL}} > ./SFDX_INTEGRATION_URL.txt

            # Authenticate to org using the URL stored in the text file
            - name: 'Authenticate to Org'
              run: sfdx auth:sfdxurl:store -f ./SFDX_INTEGRATION_URL.txt -s -a integration

            # We use SFDX Git Delta to create a directory with only the metadata that has changed.
            # this allows us to deploy only those changes, as opposed to deploying the entire branch. 
            # This helps reducing deployment times
            - name: 'Create delta packages for new, modified or deleted metadata'
              run: | 
                  mkdir changed-sources
                  sfdx sgd:source:delta --to "HEAD" --from "HEAD^" --output changed-sources/ --generate-delta --source force-app/ 

            # Now we can use the sfdx scanner to scan the code in the delta directory
            # The output of the scan is stored in a file called apexScanResults.sarif

            # The .sarif file can later be uploaded to github, so that we can see the 
            # results of the scan directly from the PR.

            - name: 'Scan code'
              run: |
                  cd changed-sources
                  sfdx scanner:run --format sarif --target './**/*.cls' --category "Design,Best Practices,Performance" --outfile 'apexScanResults.sarif'  
                  cd ..

            # Now we upload the .sarif file as explained in the previous step
            - name: Upload SARIF file
              uses: github/codeql-action/upload-sarif@v1
              with:
                sarif_file: changed-sources/apexScanResults.sarif

	#Run the validation with specific test classes 
	 - name: 'Check-only deploy delta changes - run specified tests'
              if: ${{ env.APEX_TESTS != 'all' }}
              run: |
                  echo ${{env.APEX_TESTS}}
                  sfdx force:source:deploy -p "changed-sources/force-app" --checkonly --testlevel RunSpecifiedTests --runtests ${{env.APEX_TESTS}} --json 

    # If the env variable equals all, we run all tests
            - name: 'Check-only deploy delta changes - run all tests'
              if: ${{ env.APEX_TESTS == 'all' }}
              run: |
                  sfdx force:source:deploy -p "changed-sources/force-app" --checkonly --testlevel RunLocalTests  --json

            - name: 'Deploy destructive changes (if any)'
              run: sfdx force:mdapi:deploy -d "changed-sources/destructiveChanges" --checkonly --ignorewarnings 
  

